{% extends "base.html" %}

{% block title %}Dashboard - Twitter Unfollow Bot{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1>Dashboard</h1>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Total Followers</h5>
                <h2 class="text-primary" id="stat-total">{{ total_followers }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Bots Detected</h5>
                <h2 class="text-danger" id="stat-bots">{{ bots }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Inactive Accounts</h5>
                <h2 class="text-warning" id="stat-inactive">{{ inactive }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Unfollowed Today</h5>
                <h2 class="text-info" id="stat-unfollowed">{{ unfollowed_today }}</h2>
            </div>
        </div>
    </div>
</div>

<!-- Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Actions</h5>
                <button id="btn-analyze" class="btn btn-primary me-2">
                    <i class="bi bi-arrow-repeat"></i> Analyze Followers
                </button>
                <button id="btn-unfollow-selected" class="btn btn-danger me-2" disabled>
                    <i class="bi bi-person-x"></i> Unfollow Selected
                </button>
                <a href="/api/export/csv" class="btn btn-secondary">
                    <i class="bi bi-download"></i> Export CSV
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-3">
                        <label class="form-label">Filter</label>
                        <select id="filter-type" class="form-select">
                            <option value="">All Followers</option>
                            <option value="bots">Bots Only</option>
                            <option value="inactive">Inactive Only</option>
                            <option value="both">Bots & Inactive</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Sort By</label>
                        <select id="sort-by" class="form-select">
                            <option value="bot_score">Bot Score</option>
                            <option value="username">Username</option>
                            <option value="followers">Followers</option>
                            <option value="last_tweet">Last Tweet</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Search</label>
                        <input type="text" id="search-input" class="form-control" placeholder="Search username...">
                    </div>
                    <div class="col-md-3">
                        <button id="btn-apply-filters" class="btn btn-primary w-100">Apply Filters</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Followers Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="select-all">
                                </th>
                                <th>Username</th>
                                <th>Display Name</th>
                                <th>Bio</th>
                                <th>Followers</th>
                                <th>Following</th>
                                <th>Tweets</th>
                                <th>Bot Score</th>
                                <th>Status</th>
                                <th>Last Tweet</th>
                            </tr>
                        </thead>
                        <tbody id="followers-table-body">
                            <tr>
                                <td colspan="10" class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <nav>
                    <ul class="pagination justify-content-center" id="pagination">
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Unfollow Confirmation Modal -->
<div class="modal fade" id="unfollowModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Unfollow</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to unfollow <strong id="unfollow-count">0</strong> user(s)?</p>
                <p class="text-muted small">This action can be undone within 24 hours.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-unfollow">Unfollow</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 0;
const pageSize = 50;
let selectedUsers = new Set();

// Load followers on page load
document.addEventListener('DOMContentLoaded', function() {
    loadFollowers();
    
    // Event listeners
    document.getElementById('btn-analyze').addEventListener('click', analyzeFollowers);
    document.getElementById('btn-unfollow-selected').addEventListener('click', showUnfollowModal);
    document.getElementById('confirm-unfollow').addEventListener('click', unfollowUsers);
    document.getElementById('btn-apply-filters').addEventListener('click', loadFollowers);
    document.getElementById('select-all').addEventListener('change', toggleSelectAll);
    
    // Search on enter
    document.getElementById('search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            loadFollowers();
        }
    });
});

function loadFollowers() {
    const filterType = document.getElementById('filter-type').value;
    const sortBy = document.getElementById('sort-by').value;
    const search = document.getElementById('search-input').value;
    
    const url = `/api/followers?skip=${currentPage * pageSize}&limit=${pageSize}&filter_type=${filterType}&sort_by=${sortBy}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            displayFollowers(data.followers, search);
            updatePagination(data.total);
        })
        .catch(error => {
            console.error('Error loading followers:', error);
            document.getElementById('followers-table-body').innerHTML = 
                '<tr><td colspan="10" class="text-center text-danger">Error loading followers</td></tr>';
        });
}

function displayFollowers(followers, search) {
    const tbody = document.getElementById('followers-table-body');
    
    if (followers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center">No followers found</td></tr>';
        return;
    }
    
    // Filter by search if provided
    let filtered = followers;
    if (search) {
        const searchLower = search.toLowerCase();
        filtered = followers.filter(f => 
            f.username.toLowerCase().includes(searchLower) ||
            (f.display_name && f.display_name.toLowerCase().includes(searchLower))
        );
    }
    
    tbody.innerHTML = filtered.map(follower => {
        const botScoreClass = follower.bot_score >= 60 ? 'score-high' : 
                             follower.bot_score >= 40 ? 'score-medium' : 'score-low';
        const badges = [];
        if (follower.is_bot) badges.push('<span class="badge bot-badge">Bot</span>');
        if (follower.is_inactive) badges.push('<span class="badge inactive-badge">Inactive</span>');
        
        return `
            <tr>
                <td>
                    <input type="checkbox" class="user-checkbox" value="${follower.twitter_id}" 
                           ${selectedUsers.has(follower.twitter_id) ? 'checked' : ''}>
                </td>
                <td><strong>@${follower.username}</strong></td>
                <td>${follower.display_name || '-'}</td>
                <td><small>${(follower.bio || '').substring(0, 50)}${(follower.bio || '').length > 50 ? '...' : ''}</small></td>
                <td>${follower.followers_count.toLocaleString()}</td>
                <td>${follower.following_count.toLocaleString()}</td>
                <td>${follower.tweet_count.toLocaleString()}</td>
                <td class="${botScoreClass}">${follower.bot_score.toFixed(1)}</td>
                <td>${badges.join(' ')}</td>
                <td><small>${follower.last_tweet_at ? new Date(follower.last_tweet_at).toLocaleDateString() : 'Never'}</small></td>
            </tr>
        `;
    }).join('');
    
    // Add event listeners to checkboxes
    document.querySelectorAll('.user-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                selectedUsers.add(this.value);
            } else {
                selectedUsers.delete(this.value);
            }
            updateUnfollowButton();
        });
    });
}

function updatePagination(total) {
    const pagination = document.getElementById('pagination');
    const totalPages = Math.ceil(total / pageSize);
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let html = '';
    for (let i = 0; i < totalPages; i++) {
        html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i + 1}</a>
        </li>`;
    }
    pagination.innerHTML = html;
}

function goToPage(page) {
    currentPage = page;
    loadFollowers();
}

function toggleSelectAll() {
    const selectAll = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('.user-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
        if (selectAll.checked) {
            selectedUsers.add(checkbox.value);
        } else {
            selectedUsers.delete(checkbox.value);
        }
    });
    
    updateUnfollowButton();
}

function updateUnfollowButton() {
    const btn = document.getElementById('btn-unfollow-selected');
    btn.disabled = selectedUsers.size === 0;
    btn.textContent = `Unfollow Selected (${selectedUsers.size})`;
}

function analyzeFollowers() {
    const btn = document.getElementById('btn-analyze');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Analyzing...';
    
    fetch('/api/analyze', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            alert(`Successfully analyzed ${data.total} followers!`);
            loadFollowers();
            location.reload(); // Reload to update stats
        })
        .catch(error => {
            console.error('Error analyzing followers:', error);
            alert('Error analyzing followers. Please try again.');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Analyze Followers';
        });
}

function showUnfollowModal() {
    const count = selectedUsers.size;
    if (count === 0) return;
    
    document.getElementById('unfollow-count').textContent = count;
    const modal = new bootstrap.Modal(document.getElementById('unfollowModal'));
    modal.show();
}

function unfollowUsers() {
    const userIds = Array.from(selectedUsers);
    const formData = new FormData();
    formData.append('user_ids', JSON.stringify(userIds));
    formData.append('reason', 'manual');
    
    const btn = document.getElementById('confirm-unfollow');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Unfollowing...';
    
    fetch('/api/unfollow', {
        method: 'POST',
        body: formData
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Successfully unfollowed ${data.unfollowed} user(s)!`);
                selectedUsers.clear();
                loadFollowers();
                location.reload(); // Reload to update stats
            } else {
                alert('Error unfollowing users. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error unfollowing users:', error);
            alert('Error unfollowing users. Please try again.');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = 'Unfollow';
            bootstrap.Modal.getInstance(document.getElementById('unfollowModal')).hide();
        });
}
</script>
{% endblock %}

